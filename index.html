<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DACV - Anexo I (MVP Offline)</title>

  <!-- jsPDF (PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f5f7fb; color:#111; }
    header { background:#0b2f5b; color:#fff; padding: 14px 16px; }
    header h1 { margin:0; font-size: 16px; font-weight: 700; }
    header p { margin:6px 0 0; font-size: 12px; opacity:.9; }
    main { padding: 14px 12px 28px; max-width: 1100px; margin: 0 auto; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1.1fr .9fr; } }
    .card { background:#fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); padding: 12px; }
    .row { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 680px){ .row.cols2 { grid-template-columns: 1fr 1fr; } .row.cols3 { grid-template-columns: 1fr 1fr 1fr; } }
    label { display:block; font-size: 12px; font-weight: 700; margin: 0 0 6px; color:#1b2b3a; }
    input, select, textarea, button { width: 100%; box-sizing:border-box; padding: 10px; border: 1px solid #d6dbe6; border-radius: 10px; font-size: 14px; background:#fff; }
    textarea { min-height: 78px; resize: vertical; }
    button { cursor:pointer; font-weight: 700; border: 0; }
    .btn { background:#0b2f5b; color:#fff; }
    .btn2 { background:#e7eefb; color:#0b2f5b; border: 1px solid #b7c8ea; }
    .btnDanger { background:#b42318; color:#fff; }
    .muted { font-size: 12px; color:#516277; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background:#eef3ff; color:#0b2f5b; font-size: 12px; font-weight: 700; }
    .tableWrap { overflow:auto; border: 1px solid #e6e9f2; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; min-width: 720px; }
    th, td { border-bottom:1px solid #edf0f7; padding: 10px; vertical-align: top; }
    th { background:#f2f6ff; font-size: 12px; text-align:left; }
    td input, td select, td textarea { padding: 8px; border-radius: 10px; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; }
    .actions > button { width: auto; padding: 10px 12px; border-radius: 10px; }
    .split { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; justify-content: space-between; }
    .list { display:flex; flex-direction: column; gap: 10px; }
    .itemCard { border: 1px solid #e6e9f2; border-radius: 12px; padding: 10px; display:flex; flex-direction: column; gap: 6px; }
    .itemCard strong { font-size: 13px; }
    .itemCard small { color:#516277; }
    canvas { width:100%; height: 150px; border: 1px dashed #aab7cf; border-radius: 12px; background:#fff; touch-action: none; }
    .thumb { width:100%; max-width: 280px; border:1px solid #e6e9f2; border-radius: 12px; }
    .hr { height:1px; background:#edf0f7; margin: 10px 0; }
    .note { background:#fff7e6; border:1px solid #ffd48a; padding:10px; border-radius: 12px; color:#6b4b00; font-size: 12px; }
  </style>
</head>

<body>
<header>
  <h1>DACV (Anexo I) — MVP Offline (GitHub Pages)</h1>
  <p>Preencha em campo no celular, salve localmente, exporte PDF e Excel consolidado.</p>
</header>

<main>
  <div class="note">
    <b>Dica:</b> no iPhone/Android você pode “Adicionar à tela inicial” para usar como app.  
    Este MVP salva em <b>localStorage</b> (limite). Por isso, a foto é limitada a <b>1 por laudo</b>.
  </div>

  <div class="grid" style="margin-top:12px;">
    <!-- LEFT: Form -->
    <section class="card">
      <div class="split">
        <div>
          <span class="pill">Formulário</span>
          <div class="muted" style="margin-top:6px;">Campos + checklist por categoria (4 rodas / 2 rodas / pesados).</div>
        </div>
        <div class="actions">
          <button class="btn2" id="btnNovo">Novo laudo</button>
          <button class="btn2" id="btnSalvar">Salvar laudo</button>
          <button class="btn2" id="btnPDF">Exportar PDF</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols3">
        <div>
          <label>Categoria</label>
          <select id="categoria">
            <option value="4R">I - Veículos quatro rodas</option>
            <option value="2R">II - Veículos duas rodas ou assemelhados</option>
            <option value="PES">III - Veículos pesados</option>
          </select>
        </div>
        <div>
          <label>Identificação única (ID)</label>
          <input id="idLaudo" placeholder="Gerado automaticamente" readonly />
        </div>
        <div>
          <label>Data da avaliação</label>
          <input id="dataAvaliacao" type="date" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols2">
        <div>
          <label>1. Identificação do lote — Lote</label>
          <input id="lote" placeholder="Ex.: 1783" />
        </div>
        <div>
          <label>Placas</label>
          <input id="placas" placeholder="Ex.: ABC1D23; DEF4G56" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Ano Fab/Mod</label>
          <input id="anoFabMod" placeholder="Ex.: 2018/2019" />
        </div>
        <div>
          <label>Marca/Modelo</label>
          <input id="marcaModelo" placeholder="Ex.: FIAT ARGO" />
        </div>
      </div>

      <div class="row cols3">
        <div>
          <label>Cor</label>
          <input id="cor" placeholder="Ex.: PRATA" />
        </div>
        <div>
          <label>Nº Chassi (VIN)</label>
          <input id="vin" placeholder="Ex.: 9BWZZZ..." />
        </div>
        <div>
          <label>Nº Motor</label>
          <input id="motor" placeholder="Ex.: ABC123..." />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Tipo</label>
          <input id="tipo" placeholder="Ex.: Automóvel / Motocicleta / Caminhão" />
        </div>
        <div>
          <label>Local da vistoria</label>
          <input id="localVistoria" placeholder="Ex.: Pátio X - Cidade" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Referência mercadológica (FIPE) — R$</label>
          <input id="fipe" inputmode="decimal" placeholder="Ex.: 35000,00" />
        </div>
        <div>
          <label>2. Itens de verificação estrutural</label>
          <div class="muted">Preencha na tabela abaixo.</div>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th style="width: 34%;">Item</th>
              <th style="width: 26%;">Status</th>
              <th>Observações</th>
            </tr>
          </thead>
          <tbody id="tbodyItens"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      <div class="row cols2">
        <div>
          <label>3. Danos estruturais</label>
          <select id="danoEstrutural">
            <option value="Sem">Sem danos estruturais</option>
            <option value="Leve">Dano leve</option>
            <option value="Moderado">Dano moderado</option>
            <option value="Severo">Dano severo/irrecuperável</option>
          </select>
        </div>
        <div>
          <label>Observações de danos</label>
          <textarea id="danoObs" placeholder="Descreva detalhes relevantes..."></textarea>
        </div>
      </div>

      <div class="row cols3">
        <div>
          <label>4. Classificação</label>
          <select id="classificacao">
            <option value="Conservado">Conservado</option>
            <option value="Sucata_Aproveitavel">Sucata aproveitável</option>
            <option value="Sucata_Aproveitavel_Motor_Inservivel">Sucata aproveitável (motor inservível)</option>
            <option value="Sucata_Inservivel">Sucata inservível</option>
            <option value="Inadequado">Inadequado para leilão</option>
          </select>
        </div>
        <div>
          <label>Avaliação — R$</label>
          <input id="avaliacao" inputmode="decimal" placeholder="Ex.: 18000,00" />
        </div>
        <div>
          <label>Lance mínimo — R$</label>
          <input id="lanceMinimo" inputmode="decimal" placeholder="Ex.: 12000,00" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Observações da classificação</label>
          <textarea id="classObs" placeholder="Justificativa / notas do avaliador..."></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols2">
        <div>
          <label>5. Evidência (1 foto)</label>
          <input id="fotos" type="file" accept="image/*" capture="environment" multiple />
          <div class="muted">Selecione até 3 fotos.</div>
          <div id="fotosPreview"></div>
          <img id="fotoPreview" class="thumb" style="display:none; margin-top:10px;" alt="preview" />
        </div>

        <div>
          <label>6. Responsável pela avaliação</label>
          <div class="row cols2">
            <div>
              <label style="font-weight:700;">Nome do avaliador</label>
              <input id="nomeAvaliador" placeholder="Nome completo" />
            </div>
            <div>
              <label style="font-weight:700;">Identificação única</label>
              <input id="identAvaliador" placeholder="Matrícula/CPF/Registro" />
            </div>
          </div>

          <div style="margin-top:8px;">
            <label>Assinatura (desenhe com o dedo)</label>
            <canvas id="assinatura" width="900" height="300"></canvas>
            <div class="actions" style="margin-top:10px;">
              <button class="btn2" id="btnLimparAss">Limpar assinatura</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Saved / Export -->
    <aside class="card">
      <div class="split">
        <div>
          <span class="pill">Laudos salvos</span>
          <div class="muted" style="margin-top:6px;">Clique em um laudo para carregar no formulário.</div>
        </div>
        <div class="actions">
          <button class="btn" id="btnXLSX">Exportar Excel</button>
          <button class="btnDanger" id="btnApagarTudo">Apagar tudo</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="listaLaudos" class="list"></div>
    </aside>
  </div>
</main>

<script>
/** =========================
 *  Configuração (itens por categoria)
 *  ========================= */
const ITENS = {
  "4R": [
    "Integridade da carroceria",
    "Longarinas dianteiras",
    "Longarinas traseiras",
    "Colunas A",
    "Colunas B",
    "Colunas C ou D",
    "Teto",
    "Assoalho",
    "Painel corta-fogo",
    "Agregados / suporte motor e suspensão",
    "Interior (bancos/painel)",
    "Vidros (para-brisa/vigia)",
    "Motor (numeração visível/completo)",
    "Chassi (numeração VIN visível)"
  ],
  "2R": [
    "Mesa superior (suspensão dianteira)",
    "Mesa inferior (suspensão dianteira)",
    "Coluna de direção",
    "Garfo dianteiro",
    "Garfo traseiro",
    "Estrutura / chassi",
    "Motor (numeração visível)",
    "Chassi (numeração visível)",
    "Eixo traseiro (triciclo/quadriciclo)"
  ],
  "PES": [
    "Cabine/colunas (lado direito)",
    "Cabine/colunas (lado esquerdo)",
    "Painel corta-fogo",
    "Assoalho / soleiras",
    "Interior (bancos/painel)",
    "Carroceria (laterais/teto)",
    "Para-choque traseiro",
    "Seção dianteira (ônibus)",
    "Seção traseira (ônibus)",
    "Seção central (ônibus)",
    "Motor (numeração visível)"
  ],
};

const STORAGE_KEY = "dacv_laudos_v1";

/** =========================
 *  Utilidades
 *  ========================= */
const $ = (id) => document.getElementById(id);

const SYNC_ENDPOINT = "https://script.google.com/macros/s/AKfycbzAa-ojSMezmHb-zlRBzjdGmMWZLrvYeb8rs3be13gbJ3e38bviILw5lnbPehkf9ypX8Q/exec";
const SYNC_TOKEN = "TOKENTOKENTOKEN";
const BATCH_SIZE = 25;

// ===== IndexedDB (sem libs) =====
const DB_NAME = "dacv_db_v2";
const DB_VERSION = 1;
const STORE_LAUDOS = "laudos";
const STORE_OPS = "ops"; // fila de operações

function nowISODate() {
  const d = new Date();
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off * 60000);
  return local.toISOString().slice(0,10);
}

function genId() {
  // ID curto e rastreável
  const ts = Date.now().toString(36).toUpperCase();
  const rnd = Math.random().toString(36).slice(2, 7).toUpperCase();
  return `DACV-${ts}-${rnd}`;
}

function parseMoney(str) {
  if (!str) return "";
  const s = String(str).trim().replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : "";
}

function fmtMoney(n) {
  if (n === "" || n === null || n === undefined) return "";
  const val = Number(n);
  if (!Number.isFinite(val)) return "";
  return val.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

async function laudoUpsertLocal(laudo) {
  await idbPut(STORE_LAUDOS, laudo);
}

async function laudoDeleteLocal(idLaudo) {
  await idbDelete(STORE_LAUDOS, idLaudo);
}

async function laudoListLocal() {
  const all = await idbGetAll(STORE_LAUDOS);
  all.sort((a,b) => String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")));
  return all;
}

function makeOpId() {
  return "OP-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).slice(2,7).toUpperCase();
}

async function enqueueUpsert(laudo) {
  // remove ops antigas do mesmo id (mantém só a última)
  const ops = await idbGetAll(STORE_OPS);
  for (const op of ops) {
    const sameId =
      (op.action === "upsert" && op.laudo?.idLaudo === laudo.idLaudo) ||
      (op.action === "delete" && op.idLaudo === laudo.idLaudo);
    if (sameId) await idbDelete(STORE_OPS, op.opId);
  }
  await idbPut(STORE_OPS, { opId: makeOpId(), action: "upsert", laudo, ts: Date.now() });
}

async function enqueueDelete(idLaudo) {
  const ops = await idbGetAll(STORE_OPS);
  for (const op of ops) {
    const sameId =
      (op.action === "upsert" && op.laudo?.idLaudo === idLaudo) ||
      (op.action === "delete" && op.idLaudo === idLaudo);
    if (sameId) await idbDelete(STORE_OPS, op.opId);
  }
  await idbPut(STORE_OPS, { opId: makeOpId(), action: "delete", idLaudo, ts: Date.now() });
}

async function opsList() {
  const ops = await idbGetAll(STORE_OPS);
  ops.sort((a,b) => (a.ts||0) - (b.ts||0)); // FIFO
  return ops;
}

async function postBatch(opsBatch) {
  const payload = {
    token: SYNC_TOKEN,
    action: "batch",
    ops: opsBatch.map(op => (
      op.action === "upsert"
        ? { action: "upsert", laudo: stripPhotos(op.laudo) }
        : { action: "delete", idLaudo: op.idLaudo }
    ))
  };

  try {
    const res = await fetch(SYNC_ENDPOINT, {
      method: "POST",
      body: JSON.stringify(payload),
      cache: "no-store",
      redirect: "follow",
    });

    // Se chegou aqui, houve resposta HTTP (não é reset de conexão)
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { json = { ok: false, raw: text }; }

    return json;
  } catch (e) {
    // Aqui entra ERR_CONNECTION_RESET / Failed to fetch
    return { ok: false, networkError: true, message: String(e?.message || e) };
  }
}


function stripPhotos(laudo) {
  // Não manda fotos pro Sheets (performance)
  const copy = { ...laudo };
  delete copy.fotos;        // array de 3 base64
  delete copy.assinaturaPng; // opcional: se quiser mandar, pode manter. Eu recomendo não mandar.
  return copy;
}

async function syncPending() {
  
  
  if (!navigator.onLine) return { ok:false, reason:"offline" };

  const ops = await opsList();
  if (!ops.length) return { ok:true, sent:0, remaining:0 };

  let sent = 0;
  let idx = 0;

  while (idx < ops.length) {
    const batch = ops.slice(idx, idx + BATCH_SIZE);
    try {
      const resp = await postBatch(batch);
      console.log("SYNC batch resp:", resp);

      if (resp && resp.ok) {
        // remove ops confirmadas
        for (const op of batch) await idbDelete(STORE_OPS, op.opId);
        sent += batch.length;
        idx += BATCH_SIZE;
      } else {
        // falhou: para e mantém fila
        break;
      }
    } catch (e) {
      console.error("SYNC error:", e);
      
      break;
    }
  }
  

  const remaining = (await opsList()).length;
  return { ok: remaining === 0, sent, remaining };
}

window.addEventListener("online", () => syncPending());



function categoryLabel(cat) {
  return cat === "4R" ? "I - Veículos quatro rodas"
       : cat === "2R" ? "II - Veículos duas rodas ou assemelhados"
       : "III - Veículos pesados";
}

/** =========================
 *  Render checklist
 *  ========================= */
function renderItens(categoria, existingItens = null) {
  const tbody = $("tbodyItens");
  tbody.innerHTML = "";
  const itens = ITENS[categoria] || [];

  for (let i = 0; i < itens.length; i++) {
    const itemNome = itens[i];

    const tr = document.createElement("tr");

    const tdItem = document.createElement("td");
    tdItem.textContent = itemNome;

    const tdStatus = document.createElement("td");
    const sel = document.createElement("select");
    sel.innerHTML = `
      <option value="Integro">Íntegro</option>
      <option value="Danificado">Danificado</option>
      <option value="Inexistente">Inexistente</option>
    `;

    const tdObs = document.createElement("td");
    const obs = document.createElement("textarea");
    obs.placeholder = "Observações...";
    obs.style.minHeight = "44px";

    // carregar existentes
    if (existingItens && existingItens[itemNome]) {
      sel.value = existingItens[itemNome].status || "Integro";
      obs.value = existingItens[itemNome].obs || "";
    }

    sel.dataset.item = itemNome;
    obs.dataset.item = itemNome;

    tdStatus.appendChild(sel);
    tdObs.appendChild(obs);

    tr.appendChild(tdItem);
    tr.appendChild(tdStatus);
    tr.appendChild(tdObs);

    tbody.appendChild(tr);
  }
}

function collectItensFromUI() {
  const result = {};
  // status
  document.querySelectorAll("#tbodyItens select").forEach(sel => {
    const k = sel.dataset.item;
    result[k] = result[k] || {};
    result[k].status = sel.value;
  });
  // obs
  document.querySelectorAll("#tbodyItens textarea").forEach(t => {
    const k = t.dataset.item;
    result[k] = result[k] || {};
    result[k].obs = t.value || "";
  });
  return result;
}

/** =========================
 *  Assinatura (canvas)
 *  ========================= */
(function initSignature() {
  const canvas = $("assinatura");
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#0b2f5b";

  let drawing = false;
  let last = null;

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const isTouch = e.touches && e.touches[0];
    const clientX = isTouch ? e.touches[0].clientX : e.clientX;
    const clientY = isTouch ? e.touches[0].clientY : e.clientY;
    return { x: (clientX - rect.left) * (canvas.width / rect.width),
             y: (clientY - rect.top)  * (canvas.height / rect.height) };
  }

  function start(e) {
    drawing = true;
    last = getPos(e);
  }

  function move(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    last = pos;
  }

  function end() {
    drawing = false;
    last = null;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);

  canvas.addEventListener("touchstart", start, { passive: false });
  canvas.addEventListener("touchmove", move, { passive: false });
  canvas.addEventListener("touchend", end);

  $("btnLimparAss").addEventListener("click", () => {
    ctx.clearRect(0,0,canvas.width,canvas.height);
  });
})();

function getSignatureDataURL() {
  const canvas = $("assinatura");
  // checa se há traço: amostragem simples
  const ctx = canvas.getContext("2d");
  const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let nonEmpty = 0;
  for (let i=3; i<pixels.length; i+=4) { // alpha
    if (pixels[i] !== 0) { nonEmpty++; if (nonEmpty > 50) break; }
  }
  if (nonEmpty <= 50) return ""; // considera vazio
  return canvas.toDataURL("image/png");
}

/** =========================
 *  Foto (1)
 *  ========================= */

let fotosData = []; // array base64


async function compressImage(file, maxWidth = 1280, quality = 0.75) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxWidth / img.width);
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const base64 = canvas.toDataURL("image/jpeg", quality);
        resolve(base64);
      };
      img.onerror = reject;
      img.src = reader.result;
    };

    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

$("fotos").addEventListener("change", async (e) => {
  const files = Array.from(e.target.files || []).slice(0,3);
  fotosData = [];
  for (const f of files) {
    const b64 = await compressImage(f, 1024, 0.65);
    fotosData.push(b64);
  }
  renderFotosPreview();
});

function renderFotosPreview() {
  const wrap = document.getElementById("fotosPreview");
  wrap.innerHTML = "";

  wrap.style.display = "grid";
  wrap.style.gridTemplateColumns = "repeat(auto-fill, minmax(110px, 1fr))";
  wrap.style.gap = "8px";
  wrap.style.marginTop = "8px";

  fotosData.forEach((b64) => {
    const img = document.createElement("img");
    img.src = b64;
    img.style.width = "100%";
    img.style.height = "80px";
    img.style.objectFit = "cover";
    img.style.border = "1px solid #e6e9f2";
    img.style.borderRadius = "10px";
    wrap.appendChild(img);
  });
}



/** =========================
 *  Form: coletar / preencher
 *  ========================= */
function newLaudo() {
  $("categoria").value = "4R";
  $("idLaudo").value = genId();
  $("dataAvaliacao").value = nowISODate();
  $("lote").value = "";
  $("placas").value = "";
  $("anoFabMod").value = "";
  $("marcaModelo").value = "";
  $("cor").value = "";
  $("vin").value = "";
  $("motor").value = "";
  $("tipo").value = "";
  $("localVistoria").value = "";
  $("fipe").value = "";
  $("danoEstrutural").value = "Sem";
  $("danoObs").value = "";
  $("classificacao").value = "Conservado";
  $("avaliacao").value = "";
  $("lanceMinimo").value = "";
  $("classObs").value = "";
  $("nomeAvaliador").value = "";
  $("identAvaliador").value = "";

  // limpa assinatura
  const canvas = $("assinatura");
  canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);

  // ✅ limpa fotos (versão 3 fotos)
  fotosData = [];
  const fotosInput = document.getElementById("fotos");
  if (fotosInput) fotosInput.value = "";

  const fotosPrev = document.getElementById("fotosPreview");
  if (fotosPrev) fotosPrev.innerHTML = "";

  renderItens("4R");
}

function collectForm() {
  const categoria = $("categoria").value;
  const itens = collectItensFromUI();

  return {
    idLaudo: $("idLaudo").value || genId(),
    categoria,
    dataAvaliacao: $("dataAvaliacao").value || nowISODate(),
    lote: $("lote").value || "",
    placas: $("placas").value || "",
    anoFabMod: $("anoFabMod").value || "",
    marcaModelo: $("marcaModelo").value || "",
    cor: $("cor").value || "",
    vin: $("vin").value || "",
    motor: $("motor").value || "",
    tipo: $("tipo").value || "",
    localVistoria: $("localVistoria").value || "",
    fipe: parseMoney($("fipe").value),
    itens,
    danoEstrutural: $("danoEstrutural").value,
    danoObs: $("danoObs").value || "",
    classificacao: $("classificacao").value,
    avaliacao: parseMoney($("avaliacao").value),
    lanceMinimo: parseMoney($("lanceMinimo").value),
    classObs: $("classObs").value || "",
    nomeAvaliador: $("nomeAvaliador").value || "",
    identAvaliador: $("identAvaliador").value || "",
    assinaturaPng: getSignatureDataURL(),
    fotos: (Array.isArray(fotosData) ? fotosData : []).slice(0, 3),
    updatedAt: new Date().toISOString()
  };
}

function fillForm(laudo) {
  $("categoria").value = laudo.categoria || "4R";
  $("idLaudo").value = laudo.idLaudo || genId();
  $("dataAvaliacao").value = laudo.dataAvaliacao || nowISODate();
  $("lote").value = laudo.lote || "";
  $("placas").value = laudo.placas || "";
  $("anoFabMod").value = laudo.anoFabMod || "";
  $("marcaModelo").value = laudo.marcaModelo || "";
  $("cor").value = laudo.cor || "";
  $("vin").value = laudo.vin || "";
  $("motor").value = laudo.motor || "";
  $("tipo").value = laudo.tipo || "";
  $("localVistoria").value = laudo.localVistoria || "";
  $("fipe").value = fmtMoney(laudo.fipe);

  $("danoEstrutural").value = laudo.danoEstrutural || "Sem";
  $("danoObs").value = laudo.danoObs || "";
  $("classificacao").value = laudo.classificacao || "Conservado";
  $("avaliacao").value = fmtMoney(laudo.avaliacao);
  $("lanceMinimo").value = fmtMoney(laudo.lanceMinimo);
  $("classObs").value = laudo.classObs || "";
  $("nomeAvaliador").value = laudo.nomeAvaliador || "";
  $("identAvaliador").value = laudo.identAvaliador || "";

  // assinatura
  const canvas = $("assinatura");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (laudo.assinaturaPng) {
    const img = new Image();
    img.onload = () => ctx.drawImage(img, 0,0, canvas.width, canvas.height);
    img.src = laudo.assinaturaPng;
  }

  // foto
  fotosData = Array.isArray(laudo.fotos) ? laudo.fotos.slice(0,3) : [];
  renderFotosPreview();
  renderItens($("categoria").value, laudo.itens || null);
}

/** =========================
 *  Lista / CRUD
 *  ========================= */
async function refreshList() {
  const arr = await laudoListLocal(); // ✅ IndexedDB

  const wrap = $("listaLaudos");
  wrap.innerHTML = "";

  if (!arr.length) {
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = "Nenhum laudo salvo ainda.";
    wrap.appendChild(div);
    return;
  }

  arr.forEach(laudo => {
    const div = document.createElement("div");
    div.className = "itemCard";

    const title = document.createElement("strong");
    title.textContent = `${laudo.idLaudo} — ${categoryLabel(laudo.categoria)}`;

    const sub = document.createElement("small");
    sub.textContent =
      `Lote: ${laudo.lote || "-"} | Placas: ${laudo.placas || "-"} | Data: ${laudo.dataAvaliacao || "-"} | Atualizado: ${new Date(laudo.updatedAt).toLocaleString("pt-BR")}`;

    const btns = document.createElement("div");
    btns.className = "actions";

    const btnLoad = document.createElement("button");
    btnLoad.className = "btn2";
    btnLoad.textContent = "Carregar";
    btnLoad.onclick = async () => {
      // se você tem get por id:
      // const full = await idbGet(STORE_LAUDOS, laudo.idLaudo);
      // fillForm(full || laudo);
      fillForm(laudo);
    };

    const btnDel = document.createElement("button");
    btnDel.className = "btnDanger";
    btnDel.textContent = "Excluir";
    btnDel.onclick = async () => {
      if (!confirm("Excluir este laudo?")) return;

      await laudoDeleteLocal(laudo.idLaudo);
      await enqueueDelete(laudo.idLaudo);

      // se estava carregado, cria um novo
      if ($("idLaudo").value === laudo.idLaudo) newLaudo();

      await refreshList();
      if (navigator.onLine) await syncPending();
    };

    btns.appendChild(btnLoad);
    btns.appendChild(btnDel);

    div.appendChild(title);
    div.appendChild(sub);
    div.appendChild(btns);

    wrap.appendChild(div);
  });
}

/** =========================
 *  Eventos
 *  ========================= */
$("categoria").addEventListener("change", () => {
  // troca checklist mantendo o que dá (se quiser, poderia mapear)
  renderItens($("categoria").value);
});

$("btnNovo").addEventListener("click", newLaudo);

$("btnSalvar").addEventListener("click", async () => {
  const laudo = collectForm();
  await laudoUpsertLocal(laudo);
  await enqueueUpsert(laudo);

  const r = await syncPending();
  alert(navigator.onLine
    ? `Salvo ✅ | Sync enviados: ${r.sent} | pendentes: ${r.remaining}`
    : "Salvo offline ✅ (vai sincronizar quando ficar online)"
  );

  await refreshList(); // adapte para async
});

$("btnApagarTudo").addEventListener("click", async () => {
  if (!confirm("Apagar TODOS os laudos deste aparelho?")) return;

  await idbClear(STORE_LAUDOS);
  await idbClear(STORE_OPS); // limpa fila de sync também

  await refreshList();
  newLaudo();
  alert("Tudo apagado ✅");
});


$("btnPDF").addEventListener("click", async () => {
  const laudo = collectForm();
  await laudoUpsertLocal(laudo);
  await enqueueUpsert(laudo);
  if (navigator.onLine) await syncPending();
  await refreshList();
  await exportPDF(laudo);
});

$("btnXLSX").addEventListener("click", () => {
  exportXLSX();
});

/** =========================
 *  Exportar XLSX consolidado
 *  ========================= */
async function exportXLSX() {
  const all = await laudoListLocal();
  if (!all.length) { alert("Não há laudos para exportar."); return; }

  const rows = all.map(l => ({
    ID_Laudo: l.idLaudo,
    Categoria: categoryLabel(l.categoria),
    Lote: l.lote,
    Placas: l.placas,
    Ano_Fab_Mod: l.anoFabMod,
    Marca_Modelo: l.marcaModelo,
    Cor: l.cor,
    Chassi_VIN: l.vin,
    Motor: l.motor,
    Tipo: l.tipo,
    Local_Vistoria: l.localVistoria,
    FIPE_R$: l.fipe,
    Dano_Estrutural: l.danoEstrutural,
    Dano_Obs: l.danoObs,
    Classificacao: l.classificacao,
    Avaliacao_R$: l.avaliacao,
    Lance_Minimo_R$: l.lanceMinimo,
    Classificacao_Obs: l.classObs,
    Nome_Avaliador: l.nomeAvaliador,
    Identificacao_Unica: l.identAvaliador,
    Data_Avaliacao: l.dataAvaliacao,
    Itens_JSON: JSON.stringify(l.itens || {})
  }));

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Consolidado");

  const fname = `DACV_Consolidado_${nowISODate()}.xlsx`;
  XLSX.writeFile(wb, fname);
}


/** =========================
 *  Exportar PDF (jsPDF)
 *  ========================= */
async function exportPDF(laudo) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });

  const margin = 12;
  let y = 12;

  function text(txt, x, yy, size=10, bold=false) {
    doc.setFont("helvetica", bold ? "bold" : "normal");
    doc.setFontSize(size);
    doc.text(String(txt || ""), x, yy);
  }

  function line(yy) {
    doc.setDrawColor(180);
    doc.line(margin, yy, 210 - margin, yy);
  }

  function nextLine(sp=6) {
    y += sp;
    if (y > 280) { doc.addPage(); y = 12; }
  }

  // Cabeçalho
  text("ANEXO I - DOCUMENTO DE AVALIAÇÃO E CLASSIFICAÇÃO VEICULAR (DACV)", margin, y, 11, true);
  nextLine(6);
  text(categoryLabel(laudo.categoria), margin, y, 10, true);
  nextLine(6);
  line(y); nextLine(6);

  // 1. Identificação
  text("1. IDENTIFICAÇÃO DO LOTE", margin, y, 10, true); nextLine(6);

  const pairs = [
    ["ID", laudo.idLaudo],
    ["Data", laudo.dataAvaliacao],
    ["Lote", laudo.lote],
    ["Placas", laudo.placas],
    ["Ano Fab/Mod", laudo.anoFabMod],
    ["Marca/Modelo", laudo.marcaModelo],
    ["Cor", laudo.cor],
    ["Chassi (VIN)", laudo.vin],
    ["Motor", laudo.motor],
    ["Tipo", laudo.tipo],
    ["Local vistoria", laudo.localVistoria],
    ["FIPE (R$)", fmtMoney(laudo.fipe)]
  ];

  doc.setFontSize(9);
  for (const [k,v] of pairs) {
    text(`${k}:`, margin, y, 9, true);
    doc.setFont("helvetica","normal");
    doc.text(String(v||"-"), margin + 38, y);
    nextLine(5);
  }
  nextLine(2);
  line(y); nextLine(6);

  // 2. Itens estruturais (somente exceções)
text("2. ITENS (APENAS NÃO ÍNTEGROS)", margin, y, 9, true); nextLine(5);

const itens = laudo.itens || {};
const itensList = ITENS[laudo.categoria] || [];

const excecoes = [];
for (const item of itensList) {
  const st = (itens[item] && itens[item].status) ? itens[item].status : "Integro";
  const ob = (itens[item] && itens[item].obs) ? itens[item].obs : "";
  if (st !== "Integro") excecoes.push({ item, st, ob });
}

doc.setFontSize(8);
if (!excecoes.length) {
  text("Sem apontamentos (todos Íntegros).", margin, y, 8); nextLine(4.5);
} else {
  // limita quantidade para caber 1 página
  const MAX_EXCECOES = 10;
  excecoes.slice(0, MAX_EXCECOES).forEach((r) => {
    const linha = `• ${r.item} — ${r.st}${r.ob ? " — " + r.ob : ""}`;
    const lines = doc.splitTextToSize(linha, 210 - margin*2);
    // limita linhas por item
    const limited = lines.slice(0, 2);
    limited.forEach((ln) => { text(ln, margin, y, 8); nextLine(4.2); });
  });

  if (excecoes.length > MAX_EXCECOES) {
    text(`(+${excecoes.length - MAX_EXCECOES} apontamentos não exibidos para caber em 1 página)`, margin, y, 7);
    nextLine(4);
  }
}

nextLine(1);
line(y); nextLine(5);

function trunc(txt, max=180) {
  const s = String(txt || "").trim();
  return s.length > max ? (s.slice(0, max) + "…") : s;
}

const danoObsTxt = trunc(laudo.danoObs, 220);
const classObsTxt = trunc(laudo.classObs, 220);

  // 3. Danos
  text("3. DANOS ESTRUTURAIS", margin, y, 10, true); nextLine(6);
  text(`Nível: ${laudo.danoEstrutural}`, margin, y, 9, false); nextLine(5);

  if (laudo.danoObs) {
    const obsLines = doc.splitTextToSize(`Obs: ${laudo.danoObs}`, 210 - margin*2);
    for (const ln of obsLines) { text(ln, margin, y, 9); nextLine(5); }
  } else {
    text("Obs: -", margin, y, 9); nextLine(5);
  }

  nextLine(1);
  line(y); nextLine(6);

  // 4. Classificação
  text("4. CLASSIFICAÇÃO E AVALIAÇÃO", margin, y, 10, true); nextLine(6);
  text(`Classificação: ${laudo.classificacao}`, margin, y, 9); nextLine(5);
  text(`Avaliação (R$): ${fmtMoney(laudo.avaliacao) || "-"}`, margin, y, 9); nextLine(5);
  text(`Lance mínimo (R$): ${fmtMoney(laudo.lanceMinimo) || "-"}`, margin, y, 9); nextLine(5);

  if (laudo.classObs) {
    const clLines = doc.splitTextToSize(`Obs: ${laudo.classObs}`, 210 - margin*2);
    for (const ln of clLines) { text(ln, margin, y, 9); nextLine(5); }
  } else {
    text("Obs: -", margin, y, 9); nextLine(5);
  }

  nextLine(1);
  line(y); nextLine(6);

  // 5. Evidências (até 3 fotos)
    text("5. REGISTROS E EVIDÊNCIAS", margin, y, 10, true); nextLine(6);

    const fotos = Array.isArray(laudo.fotos) ? laudo.fotos.slice(0,3) : [];
    if (!fotos.length) {
     text("Sem fotos.", margin, y, 9); nextLine(5);
    } else {
         const imgW = 45, imgH = 34;
    let x = margin;

    for (let i = 0; i < fotos.length; i++) {
  try {
    text(`Foto ${i+1}:`, x, y, 8, true);
    nextLine(4);
    doc.addImage(fotos[i], "JPEG", x, y, imgW, imgH);
    x += imgW + 6;
  } catch {}
}
        y += imgH + 10;
        if (y > 270) { doc.addPage(); y = 12; }
    }


  nextLine(1);
  line(y); nextLine(6);

  // 6. Responsável
  text("6. RESPONSÁVEL PELA AVALIAÇÃO", margin, y, 10, true); nextLine(6);
  text(`Nome: ${laudo.nomeAvaliador || "-"}`, margin, y, 9); nextLine(5);
  text(`Identificação: ${laudo.identAvaliador || "-"}`, margin, y, 9); nextLine(7);

  // assinatura
  text("Assinatura:", margin, y, 9, true); nextLine(4);

  if (laudo.assinaturaPng) {
    try {
      doc.addImage(laudo.assinaturaPng, "PNG", margin, y, 140, 35);
      y += 40;
    } catch {
      text("(erro ao inserir assinatura)", margin, y, 9); nextLine(5);
    }
  } else {
    text("(sem assinatura)", margin, y, 9); nextLine(5);
  }

  const fname = `DACV_${laudo.idLaudo}.pdf`;
  doc.save(fname);
}

/** =========================
 *  Init
 *  ========================= */
function setSyncStatus(txt) {
  console.log("SYNC:", txt);
}


function idbOpen() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_LAUDOS)) {
        db.createObjectStore(STORE_LAUDOS, { keyPath: "idLaudo" });
      }
      if (!db.objectStoreNames.contains(STORE_OPS)) {
        db.createObjectStore(STORE_OPS, { keyPath: "opId" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPut(store, value) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).put(value);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function idbGet(store, key) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readonly");
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

async function idbGetAll(store) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readonly");
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

async function idbDelete(store, key) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).delete(key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function idbClear(store) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).clear();
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function deleteLaudo(idLaudo) {
  await laudoDeleteLocal(idLaudo);
  await enqueueDelete(idLaudo);
  await refreshList();

  if (navigator.onLine) await syncPending();
}


async function init() {
  newLaudo();
  await refreshList();
}
init();


// ====== CONFIG ======



window.addEventListener("online", () => syncPending());



</script>
</body>
</html>
